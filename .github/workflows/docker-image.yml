name: Docker Publish

# ä»…åœ¨æ¨é€ tag æ—¶è§¦å‘ï¼Œä¾‹å¦‚ï¼šv3.8.3, 3.8.3
on:
  push:
    tags:
      - 'v*'
      - 'latest'

env:
  # é•œåƒåç§°ï¼Œè¿™é‡Œå‡è®¾ä½ è¦æ¨é€åˆ° cloudreve/cloudreve ä»“åº“
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/cloudreve

jobs:
  # æ„å»ºå’Œæ¨é€é•œåƒä»»åŠ¡
  build_and_push:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # å®šä¹‰ç¯å¢ƒæ¡ä»¶ï¼šç¡®ä¿ Docker Hub å‡­è¯å·²è®¾ç½®
    environment:
      name: docker-hub
      
    steps:
      - name: â¬‡ï¸ Checkout code
        # è·å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Set up QEMU
        # è®¾ç½® QEMU ä»¥æ”¯æŒå¤šå¹³å°é•œåƒæ„å»º
        uses: docker/setup-qemu-action@v3
        
      - name: âš™ï¸ Set up Docker Buildx
        # è®¾ç½® Docker Buildxï¼Œç”¨äºæ›´é«˜çº§çš„æ„å»ºç‰¹æ€§ï¼Œå¦‚å¤šå¹³å°
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ Login to Docker Hub
        # ç™»å½• Docker Hubï¼Œéœ€è¦ç”¨åˆ° GitHub Secrets ä¸­çš„ DOCKERHUB_USERNAME å’Œ DOCKERHUB_TOKEN
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: ğŸ·ï¸ Extract Docker metadata
        # æå– Git tag ä½œä¸º Docker é•œåƒçš„ tag
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          # è‡ªåŠ¨ä¸º tags (å¦‚ v3.8.3) ç”Ÿæˆç›¸åº”çš„ Docker æ ‡ç­¾
          tags: |
            type=ref,event=tag
            # æ­¤å¤–ï¼Œå¦‚æœæ¨é€çš„ tag æ˜¯ 'latest'ï¼Œåˆ™ä¿ç•™ 'latest' æ ‡ç­¾
            type=raw,value=latest,enable=${{ github.ref == 'refs/tags/latest' }}
            
      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # æ¨é€æ„å»ºå¥½çš„é•œåƒ
          push: true
          # æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ï¼Œä½¿ç”¨å½“å‰ç›®å½•
          context: .
          # Dockerfile è·¯å¾„ï¼Œé»˜è®¤ä¸º ./Dockerfile
          file: ./Dockerfile 
          # ç›®æ ‡å¹³å°ï¼Œè¿™é‡Œæ„å»º amd64 å’Œ arm64 ä¸¤ä¸ªä¸»æµæ¶æ„
          platforms: |
            linux/amd64
            linux/arm64
          # ä½¿ç”¨å…ƒæ•°æ®æ­¥éª¤ç”Ÿæˆçš„æ ‡ç­¾å’Œé•œåƒå
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ç¼“å­˜è®¾ç½®ï¼ŒåŠ é€Ÿåç»­æ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
